---
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
# load libraries
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)
library(plotly)
library(ggiraph)
library(ggflags) # circle flags - use install.packages("devtools") then devtools::install_github("rensa/ggflags") if needed
library(ggimage) # rectangle flags
library(countrycode)
library(ggflags)
library(dplyr)
```

```{r}
# load library
fao_emissions <- read_csv("/Users/npepper/MEDS/capstone/emissions-dashboard/data-raw/full_emissions_fao_species.csv")
```

```{r}
# Explore data
print(unique(fao_emissions$name_en))
```


```{r}
# Calc top species
top_species <- fao_emissions |>
  group_by(name_en) |>
  summarize(sum_emissions = sum(total_co2_mt, na.rm = TRUE)) |>
  arrange(desc(sum_emissions)) |>
  head(20)
```

```{r}
# Calc top major groups
top_major_groups <- fao_emissions |>
  group_by(major_group) |>
  summarize(sum_emissions = sum(total_co2_mt, na.rm = TRUE)) |>
  arrange(desc(sum_emissions)) |>
  head(20)
```


```{r}
# Calc top isscap
top_iss_groups <- fao_emissions |>
  group_by(isscaap_group) |>
  filter(isscaap_group != "no_fao_species_catch_data") |>
  summarize(sum_emissions = sum(total_co2_mt, na.rm = TRUE)) |>
  arrange(desc(sum_emissions)) |>
  head(10)
```

```{r}
# Calc top countries
top_flags <- fao_emissions |>
  group_by(flag) |>
  summarize(sum_emissions = sum(total_co2_mt, na.rm = TRUE)) |>
  arrange(desc(sum_emissions))
```


### Plot top countries
I dropped NA and UNK
Question: Should we set NA to UNK

NA 162387172
UNK 26566516

```{r}
# Calc top countries
top_flags <- fao_emissions |>
  filter(flag != c("UNK", NA)) |>
  group_by(flag) |>
  summarize(sum_emissions = sum(total_co2_mt, na.rm = TRUE)) |>
  arrange(desc(sum_emissions)) |>
  head(10) |>
  mutate(
    iso2 = tolower(countrycode(flag, origin = "iso3c", destination = "iso2c")), # add column for iso2 from iso3
    country_name = countrycode(flag, origin = "iso3c", destination = "country.name") # add column for country name from iso3
  )
```




```{r}
library(scales)  # for comma formatting

ggplot(data = top_flags) +
  geom_bar(
    aes(x = sum_emissions, y = reorder(flag_label, sum_emissions)),
    stat = "identity",
    fill = "#08C4E5"
  ) +
  geom_flag(
    aes(country = country, y = reorder(flag_label, sum_emissions), x = 0),
    size = 15
  ) +
  geom_text(
    aes(
      x = sum_emissions + 0.09 * max(sum_emissions, na.rm = TRUE),  # offset to the right
      y = reorder(flag_label, sum_emissions),
      label = comma(sum_emissions)
    ),
    color = "white",
    family = "Roboto",
    fontface = "bold",
    size = 4
  ) +
  labs(x = "Emissions") +
  theme_void() +
  theme(
    legend.position = "none",
    axis.title.x = element_text(color = "white", family = "Roboto", face = "bold", size = 18),
    axis.text.y = element_text(color = "white", family = "Roboto", face = "bold", size = 14),
    panel.background = element_rect(fill = "#053762", color = NA),
    plot.background = element_rect(fill = "#053762", color = NA)
  ) +
  expand_limits(x = -0.05 * max(top_flags$sum_emissions, na.rm = TRUE))

```
